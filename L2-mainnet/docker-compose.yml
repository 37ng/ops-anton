# Define volumes for the containers to persist data to
volumes:
  influxdb-store:
# Use the shared network across all stacks
networks:
  anton-net:
    external: true
services:
  op-influxdb:
    image: influxdb:latest
    ports:
      - "8086:8086"
    volumes:
      - influxdb-store:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=geth
      - INFLUXDB_ADMIN_USER=geth
      - INFLUXDB_ADMIN_PASSWORD=geth
  opgeth:
    build:
      context: .
      dockerfile: ./geth/op_geth.dockerfile
    ports:
      - "30306:30306/tcp" # eth/66 peering
      - "8547:8547" # rpc
      - "8553:8553" # engine
      - "6060:6060" # metrics
    volumes:
      - "/drives/L2/op-mainnet/op-geth:/db"
    networks:
      - anton-net
    depends_on:
      - op-influxdb
  op_node:
    build:
      context: .
      dockerfile: ./op-node/op_node.dockerfile
    ports:
      - "7308:7308" # metrics
      - "5058:5058" # rpc
    volumes:
      - "/drives/L2/op-mainnet/op-node:/db"
    networks:
      - anton-net
    depends_on:
      - opgeth
  op-dispute-mon:
    build:
      context: .
      dockerfile: ./op-dispute-mon/op_dispute_mon.dockerfile
    ports:
      - "7077:7077"
    networks:
      - anton-net
    depends_on:
      - op_node
  l2-mainnet-eth-metrics-exporter:
    restart: unless-stopped
    image: ethpandaops/ethereum-metrics-exporter:debian-latest
    depends_on:
      - opgeth
      - op_node
    ports:
      - 9302:9302 # metrics
    volumes:
      - ./eth-metrics-exporter.yaml:/root/config.yaml
    command:
      - --config=/root/config.yaml
      - --metrics-port=9302
    networks:
      - anton-net
